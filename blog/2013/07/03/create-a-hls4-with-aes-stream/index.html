
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Create a HLS4 with AES stream - Benson's Programming Journey</title>
  <meta name="author" content="Benson Lim">

  
  <meta name="description" content="Edit: Found out that ffmpeg could do the segmenting instead of segmenter Here&rsquo;s a short tutorial on how to create a Http Live Stream v4 with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pugnusferreus.github.io/blog/2013/07/03/create-a-hls4-with-aes-stream">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Benson's Programming Journey" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <div id="header-inner">
    <span class="first"><img src="/favicon.png" alt="Progriff icon"/> <a href="/">Benson's Programming Journey</a></span>
    <br/>
    <span><a href="/about">about</a></span>
    <span><a href="http://www.github.com/pugnusferreus">github</a></span>
    <span><a href="https://twitter.com/pugnusferreus" title="twitter">twitter</a></span>
    <span><a href="http://www.flickr.com/photos/95990368@N08/" title="twitter">flickr</a></span>
    <span><a href="https://soundcloud.com/benson-cs-lim" title="twitter">soundcloud</a></span>
    <span class="last"><a href="/atom.xml" title="subscribe via RSS">rss</a></span>
  </div>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Create a HLS4 With AES Stream</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-03T14:21:00+10:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h4>Edit: Found out that ffmpeg could do the segmenting instead of segmenter</h4>


<p>Here&rsquo;s a short tutorial on how to create a Http Live Stream v4 with AES encryption from a MOV file with multiple language track.
Here are the list of softwares that we&rsquo;ll be using for this tutorial:</p>

<ul>
<li> <a href="http://handbrake.fr/downloads2.php">HandbrakeCLI</a></li>
<li> <a href="http://www.ffmpeg.org/download.html">FFmpeg</a></li>
</ul>


<p>If you&rsquo;re on Windows:</p>

<ul>
<li> <a href="http://slproweb.com/products/Win32OpenSSL.html">OpenSSL</a></li>
<li> <a href="http://www.richpasco.org/utilities/hexdump.html">HexDump</a></li>
</ul>


<h4>Converting the MOV file to TS file</h4>


<ol>
<li>Convert the MOV file to MP4. <code>HandBrakeCLI -i VIDEO_FILE_NAME.mov -o VIDEO_FILE_NAME.mp4 --preset=iPad -d slow</code></li>
<li>Convert the MP4 file to segments of TS file. <code>ffmpeg -i VIDEO_FILE_NAME.mp4 -acodec libfaac -vcodec libx264 -an -map 0 -f segment -segment_time 10 -segment_list segment.m3u8 -segment_format mpegts -vbsf h264_mp4toannexb -flags -global_header stream-%d.ts</code></li>
<li>Use OpenSSL to create a random key file. <code>openssl rand 16 &gt; static.key</code></li>
<li>Use hexdump on the static.key to retrieve the hex key.</li>
<li>For each TS file generated by the segmenter command, use openSSL to encrypt the TS files. <code>openssl aes-128-cbc -e -in stream-1.ts -out tsAes\stream-1.ts -p -nosalt -iv 0 -K YOUR_AES_KEY</code>. Your encrypted TS files should be in the tsAes folder.</li>
<li>Move the static.key to the <code>tsAes</code> folder.</li>
</ol>


<h4>Extracting the audio tracks from the MOV file</h4>


<p>You&rsquo;ll have to know which audio track belongs to which language. The easiest way to check the language is to play the video via VLC and identify the language of each audio track. Let&rsquo;s assume that Stream 0:1 is English and Stream 0:2 is Chinese.</p>

<ol>
<li>Extract the English audio from the MOV file. <code>ffmpeg -i VIDEO_FILE_NAME.mov -map 0:1 -ac:a:0 2 -acodec libfaac -vn track_en.aac</code></li>
<li>Extract the Chinese audio from the MOV file. <code>ffmpeg -i VIDEO_FILE_NAME.mov -map 0:2 -ac:a:0 2 -acodec libfaac -vn track_zh.aac</code></li>
<li>Go to trackEn folder and run <code>ffmpeg -i track_en.aac -map 0:1 -ac:a:0 2 -acodec libfaac -vcodec copy -dcodec copy -vn -f segment -segment_time 10 -segment_list segment.m3u8 -segment_format mpegts -vbsf h264_mp4toannexb -flags -global_header stream-%d.ts</code></li>
<li>Go to trackZh folder and run <code>track_zh.aac</code> file to TS files. <code>ffmpeg -i track_zh.aac -map 0:2 -ac:a:0 2 -acodec libfaac -vcodec copy -vn -f segment -segment_time 10 -segment_list segment.m3u8 -segment_format mpegts -vbsf h264_mp4toannexb -flags -global_header stream-%d.ts</code></li>
</ol>


<p>Edit: We&rsquo;ll need to do segmenting and the audio extraction in one line to preserve the PTS values. Incorrect PTS values will result in audio/video out of sync.</p>

<p>So finally, you should have the following directory structure.</p>

<ul>
<li>root

<ul>
<li>tsAes

<ul>
<li>all your encrypted video files</li>
<li>static.key</li>
<li>stream.m3u8</li>
</ul>
</li>
<li>trackEn

<ul>
<li>all your English audio track segments</li>
<li>stream.m3u8</li>
</ul>
</li>
<li>trackZh

<ul>
<li>all your Chinese audio track segments</li>
<li>stream.m3u8</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>On the root directory, create a stream.m3u8 file. It should look something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#EXTM3U
</span><span class='line'>#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="aac",NAME="English",DEFAULT=YES,AUTOSELECT=YES ,LANGUAGE="eng",URI="trackEn/stream.m3u8"
</span><span class='line'>#EXT-X-MEDIA:TYPE=AUDIO,GROUP-ID="aac",NAME="Chinese",DEFAULT=NO,AUTOSELECT=NO ,LANGUAGE="zho",URI="trackZh/stream.m3u8"
</span><span class='line'>
</span><span class='line'>#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=600000,AUDIO="aac"
</span><span class='line'>tsAes/stream.m3u8</span></code></pre></td></tr></table></div></figure>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Benson Lim</span></span>

      








  


<time datetime="2013-07-03T14:21:00+10:00" pubdate data-updated="true">Jul 3<span>rd</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ffmpeg/'>ffmpeg</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://pugnusferreus.github.io/blog/2013/07/03/create-a-hls4-with-aes-stream/" data-via="" data-counturl="http://pugnusferreus.github.io/blog/2013/07/03/create-a-hls4-with-aes-stream/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/06/29/moved-to-github-pages-and-octopress/" title="Previous Post: Moved to Github Pages and Octopress">&laquo; Moved to Github Pages and Octopress</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/08/21/convert-your-python-script-into-a-windows-executable/" title="Next Post: Convert your python script into a Windows executable">Convert your python script into a Windows executable &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/03/integrating-logstash-with-your-java-application/">Integrating Logstash With Your Java Application</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/09/simple-python-script-to-monitor-your-web-server/">Simple Python Script to Monitor Your Web Server</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/04/self-improvement/">Self Improvement</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/03/10-reasons-for-doing-code-reviews/">10 Reasons for Doing Code Reviews</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/02/creating-a-rest-application-with-spring-4/">Creating a REST Application With Spring 4</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  
  <p>
  Copyright &copy; 2016 - Benson Lim -
</p>


  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
